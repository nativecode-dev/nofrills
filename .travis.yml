cache:
  directories:
    - node_modules
  yarn: true
language: node_js
node_js:
  - 'node'
  - '6'
os:
  - linux
before_install:
  - echo "registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
  - curl -o- -L https://yarnpkg.com/install.sh | bash -s
  - export PATH="$HOME/.yarn/bin:$PATH"
  - yarn global add @nofrills/tasks@5.6.2 --non-interactive --silent
  - yarn install --pure-lockfile --non-interactive --silent
  - cli-tasks configure:git
  - yarn run ssh
stages:
  - test
  - name: coverage
    if: (branch = "master" OR branch = "develop")
  - name: release
    if: branch = "master" AND type != pull_request
  - name: prerelease
    if: branch = "develop" AND type != pull_request
jobs:
  include:
    - stage: coverage
      node_js: '8'
      os: linux
      script:
        - cli-tasks coverage
    - stage: prerelease
      node_js: '8'
      os: linux
      script:
        - git remote set-url origin git@github.com:nativecode-dev/nofrills.git
        - git checkout $TRAVIS_BRANCH
        - npm whoami
        - git checkout yarn.lock
        - git status
        - cli-tasks prerelease
    - stage: release
      node_js: '8'
      os: linux
      script:
        - git remote set-url origin git@github.com:nativecode-dev/nofrills.git
        - git checkout $TRAVIS_BRANCH
        - npm whoami
        - git checkout yarn.lock
        - git status
        - cli-tasks release
after_failure:
  - cat lerna-debug.log
